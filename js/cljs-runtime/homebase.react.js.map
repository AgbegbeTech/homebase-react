{"version":3,"sources":["homebase/react.cljs"],"mappings":"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","names":["homebase.react/keywordize","s","cljs.core._EQ_","cljs.core.subs","cljs.core.keyword","homebase.react/keywordize-coll","coll","cljs.core.js__GT_clj","clojure.walk/postwalk","homebase.react/transact!","conn","txs","datascript.core.transact_BANG_","var_args","args__4742__auto__","len__4736__auto__","i__4737__auto__","argseq__4743__auto__","cljs.core/IndexedSeq","homebase.react/q","seq23610","G__23611","cljs.core/first","cljs.core/next","G__23612","self__4723__auto__","query","vars","G__23613","cljs.core/deref","G__23614","datascript.core/entity","cljs.core.apply","datascript.core/q","datascript.impl.entity/Entity","this","keys","cljs.core.reduce","acc","key","cljs.core.get","js/homebase","js/homebase.react","js/homebase.react.homebase-context","homebase.react/homebase-context","js/module$node_modules$react$index.createContext","homebase.react/HomebaseProvider","props","config","datascript.core.create_conn","reagent.core.create_element","homebase.react/useQuery","vec__23615","cljs.core.nth","js/module$node_modules$react$index.useContext","result","setResult","js/module$node_modules$react$index.useState","js/module$node_modules$react$index.useEffect","cljs.core.rand","listener","G__23618","datascript.core.listen_BANG_","datascript.core/unlisten!","homebase.react/useTransact","transact"],"sourcesContent":["(ns homebase.react\n  (:require\n   [\"react\" :as react]\n   [reagent.core :as r]\n   [clojure.walk :as walk]\n   [datascript.core :as d]\n   [datascript.db :as db]\n   [datascript.impl.entity :as de :refer [Entity]]))\n\n(defn keywordize [s]\n  (if (and (string? s) (= (subs s 0 1) \":\"))\n    (keyword (subs s 1))\n    s))\n\n(defn keywordize-coll [coll]\n  (->> (js->clj coll)\n       (walk/postwalk keywordize)))\n\n(defn transact! [conn txs]\n  (d/transact! conn (keywordize-coll txs)))\n\n(defn q [query conn & vars]\n  (let [query (keywordize-coll query)]\n    (cond\n      (number? query) (d/entity @conn query)\n      :else (apply d/q query @conn vars))))\n\n\n(extend-type Entity\n  Object\n  (get [this & keys]\n    (reduce \n     (fn [acc key] (when acc (get acc (keywordize-coll key))))\n     this keys)))\n\n\n(defonce homebase-context (react/createContext))\n\n(defn ^:export HomebaseProvider [props]\n  (let [config (.-config props)\n        conn (d/create-conn (keywordize-coll (.-schema config)))]\n    (when (.-initialData config) (transact! conn (.-initialData config)))\n    (r/create-element\n     (.-Provider homebase-context) #js {:value conn}\n     (.-children props))))\n\n(defn ^:export useQuery [query]\n  (let [conn (react/useContext homebase-context)\n        [result setResult] (react/useState (q query conn))]\n    (react/useEffect \n     (fn []\n       (let [key (rand)\n             listener (fn [] (setResult (q query conn)))]\n         (d/listen! conn key listener)\n         (fn [] (d/unlisten! conn key)))))\n    [result]))\n\n(defn ^:export useTransact []\n  (let [conn (react/useContext homebase-context)\n        transact (fn [txs] (transact! conn txs))]\n    [transact]))"]}