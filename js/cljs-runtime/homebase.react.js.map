{"version":3,"sources":["homebase/react.cljs"],"mappings":"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","names":["homebase.react/keywordize-str","s","cljs.core._EQ_","cljs.core.subs","cljs.core.keyword","homebase.react/keywordize","coll","cljs.core.js__GT_clj","clojure.walk/postwalk","homebase.react/js->db-attr-overrides","homebase.react/bool-re","homebase.react/js->bool-key","string","temp__5735__auto__","vec__23905","cljs.core.nth","_","verb","key","cljs.core/re-find","homebase.react/js->key-not-memo","namespace","or__4126__auto__","cljs.core.get","camel-snake-kebab.core/->kebab-case","homebase.react/js->key","cljs.core/memoize","homebase.react/js-tx-fns","var_args","G__23915","homebase.react/js->tx","js/Error","tx","cljs.core/object?","homebase.react.js__GT_tx","vec__23919","f","e","a","v","data","cljs.core/reduce-kv","acc","k","cljs.core/coll?","cljs.core.assoc","homebase.react/js->entity-lookup","lookup","cljs.core/first","homebase.react/paths","m","cljs.core/map?","cljs.core/empty?","iter__4529__auto__","s__23944","cljs.core/LazySeq","cljs.core/seq","xs__6292__auto__","vec__23952","iterys__4525__auto__","s__23946","cljs.core/chunked-seq?","c__4527__auto__","size__4528__auto__","cljs.core/count","b__23948","cljs.core/chunk-buffer","i__23947","cljs.core/-nth","cljs.core/chunk-append","cljs.core/chunk-cons","cljs.core/chunk","iter__23945","cljs.core/chunk-rest","cljs.core/cons","cljs.core/rest","fs__4526__auto__","cljs.core.concat","iter__23943","subkey","homebase.react/str->schema-key","homebase.react/js->schema","schema","cljs.core.reduce","p__23964","vec__23965","nms","nm","p","cljs.core.get_in","cljs.core/assoc-in","args__4742__auto__","len__4736__auto__","i__4737__auto__","argseq__4743__auto__","cljs.core/IndexedSeq","homebase.react/q-entity-array","seq23989","G__23990","cljs.core/next","G__23991","self__4723__auto__","query","conn","args","cljs.core/deref","cljs.core.apply","datascript.core/q","cljs.core.map","p__23995","vec__23996","id","G__23999","G__24000","datascript.core/entity","cljs.core/to-array","homebase.react/js->datalog","map__24004","cljs.core/PROTOCOL_SENTINEL","cljs.core/hash-map","find","where","cljs.core.symbol","cljs.core.mapv","p__24009","vec__24010","av","vec__24015","vec__24018","pred","cljs.core.into","homebase.react/js->query","cljs.reader.read_string","homebase.react/js-get","entity","name","G__24028","ks","cljs.core.remove","cljs.core/keys","cljs.core/namespace","datascript.impl.entity/Entity","this","keys","cljs.core/Keyword","cljs.core/get","cljs.core/set?","G__24029","G__24030","G__24031","G__24032","homebase.react/nil->retract","temp__5733__auto__","p__24033","vec__24034","cljs.core.dissoc","homebase.react/transact!","txs","cljs.core.mapcat","cljs.core.comp","datascript.core.transact_BANG_","js/homebase","js/homebase.react","js/homebase.react.homebase-context","homebase.react/homebase-context","js/module$node_modules$react$index.createContext","homebase.react/base-schema","homebase.react/HomebaseProvider","props","config","datascript.core.create_conn","cljs.core.merge","reagent.core.create_element","homebase.react/useEntity","vec__24037","js/module$node_modules$react$index.useContext","result","setResult","js/module$node_modules$react$index.useState","G__24040","G__24041","js/module$node_modules$react$index.useEffect","cljs.core.rand","datascript.core.listen_BANG_","G__24042","G__24043","G__24044","datascript.core/unlisten!","homebase.react/useQuery","seq24045","G__24046","vec__24047","G__24050","homebase.react/useTransact","transact","cljs.core/chunk-first"],"sourcesContent":["(ns homebase.react\n  (:require\n   [\"react\" :as react]\n   [reagent.core :as r]\n   [clojure.walk :as walk]\n   [camel-snake-kebab.core :as csk]\n   [datascript.core :as d]\n   [datascript.impl.entity :as de :refer [Entity]]))\n\n(defn keywordize-str [s]\n  (if (and (string? s) (= (subs s 0 1) \":\"))\n    (keyword (subs s 1))\n    s))\n\n(defn keywordize [coll]\n  (->> (js->clj coll)\n       (walk/postwalk keywordize-str)))\n\n(def js->db-attr-overrides\n  {\"id\" :db/id\n   \"identity\" :db/ident\n   \"ident\" :db/ident})\n(def bool-re #\"^(is|has|show|hide)(-|_)?(.*)\")\n(defn js->bool-key [string]\n  (when-let [[_ verb _ key] (re-find bool-re string)]\n    (if (= \"is\" verb) (str key \"?\") (str verb \"-\" key \"?\"))))\n(defn js->key-not-memo [namespace string]\n  (or\n   (get js->db-attr-overrides string)\n   (keyword (csk/->kebab-case namespace)\n            (csk/->kebab-case\n             (or (js->bool-key string)\n                 string)))))\n(def js->key (memoize js->key-not-memo))\n\n(comment\n  (js->key \"ok\" \"watThing\")\n  (js->key \"ok\" \"id\")\n  (js->key \"ok\" \"is_good\"))\n\n(def js-tx-fns\n  {\"add\" :db/add\n   \"retract\" :db/retract\n   \"retractEntity\" :db.fn/retractEntity})\n\n(defn js->tx\n  ([tx] \n   (if (object? tx) \n     (js->tx tx \"db\")\n     (let [[f e a v] tx]\n       [(get js-tx-fns f) e (keywordize a) v])))\n  ([data namespace]\n   (reduce-kv\n    (fn [acc k v]\n      (if (coll? v)\n        (js->tx v k)\n        (assoc acc (js->key namespace k) v)))\n    {} (js->clj data))))\n\n(defn js->entity-lookup [lookup]\n  (cond\n    (number? lookup) lookup\n    (object? lookup) (first (js->tx lookup))\n    :else nil))\n(comment\n  (js->tx #js {\"user\" {\"id\" -2\n                       \"name\" \"Arpegius\"}})\n  (map js->tx #js [{\"todoFilter\" {\"identity\" \"todoFilters\"\n                                  \"showCompleted\" true\n                                  \"project\" 0}}])\n  (first (js->tx #js {\"identity\" \"wat\"}))\n  (js->entity-lookup 1)\n  (js->entity-lookup #js {\"identity\" \"todoFilters\"}))\n\n(defn paths [m]\n  (if (or (not (map? m)) (empty? m))\n    '(())\n    (for [[k v] m\n          subkey (paths v)]\n      (cons k subkey))))\n\n(def str->schema-key\n  {\"unique\" :db/unique\n   \"identity\" :db.unique/identity\n   \"type\" :db/valueType\n   \"ref\" :db.type/ref})\n(defn js->schema [schema]\n  (let [schema (js->clj schema)]\n    (reduce (fn [acc [nms nm k :as p]]\n              (let [v (get str->schema-key (get-in schema p))\n                    k (get str->schema-key k)]\n                (assoc-in acc [(js->key nms nm) k] v)))\n            {} (paths schema))))\n(comment\n  (=\n   {:project/name #:db{:unique :db.unique/identity}\n    :todo/project #:db{:valueType :db.type/ref, :unique :db.unique/identity}\n    :todo/owner #:db{:valueType :db.type/ref}}\n   (js->schema #js {\"project\" {\"name\" {\"unique\" \"identity\"}}\n                    \"todo\" {\"project\" {\"type\" \"ref\"\n                                       \"unique\" \"identity\"}\n                            \"owner\" {\"type\" \"ref\"}}})))\n\n(defn q-entity-array [query conn & args]\n  (->> (apply d/q query @conn args)\n       (map (fn [[id]] (d/entity @conn id)))\n       to-array))\n(defn js->datalog [data]\n  (let [{find \"$find\" where \"$where\"} (js->clj data)]\n    {:find [(symbol (str \"?\" find))]\n     :where (mapv\n             (fn [[e av]]\n               (let [[[a v]] (seq av)\n                     pred [(symbol (str \"?\" e))\n                           (keyword e a)]]\n                 (if (= v \"$any\") pred\n                     (into pred [v]))))\n             where)}))\n(comment\n  (=\n   '[:find ?project\n     :where [[?project :project/name]]]\n   (js->datalog\n    #js {\"$find\" \"project\"\n         \"$where\" {\"project\" {\"name\" \"$any\"}}})))\n(defn js->query [query]\n  (cond\n    ; Assume datalog\n    ; NOTE: this only supports the most basic find clauses\n    ;       E.g. `:find ?e`\n    ;       Not  `:find ?e ...` or `:find ?e .` or `:find ?e ?a ?b`\n    ; TODO: should this support more complex :find queries?\n    (string? query) (cljs.reader/read-string query)\n    ; Assume JSON style query\n    (object? query) (js->datalog query)\n    :else nil))\n\n(defn js-get [entity name]\n  (case name\n    \"id\" (:db/id entity)\n    \"ident\" (:db/ident entity)\n    \"identity\" (:db/ident entity)\n    (let [ks (remove #{:db/id :db/ident} (keys entity))\n          ; This assumes that every entity only has keys of the same namespace once the :db keys are removed\n          nms (namespace (first ks))\n          k (js->key nms name)]\n      (get entity k))))\n\n(extend-type Entity\n  Object\n  (get [this & keys]\n    (reduce\n     (fn [acc key]\n       (let [key (keywordize key)\n             f (if (keyword? key) get js-get)]\n         (cond\n           (set? acc) (f (first acc) (keywordize key))\n           acc (f acc (keywordize key))\n           :else nil)))\n     this keys)))\n\n\n(defn nil->retract [tx]\n  (if-let [id (:db/id tx)]\n    (map (fn [[k v]] \n           [(if (nil? v) :db/retract :db/add) id k v]) \n         (dissoc tx :db/id))\n    [tx]))\n(defn transact! [conn txs]\n  (let [txs (mapcat (comp nil->retract js->tx) txs)]\n    (d/transact! conn txs)))\n\n\n(defonce homebase-context (react/createContext))\n\n(def base-schema\n  {:db/ident {:db/unique :db.unique/identity}})\n\n(defn ^:export HomebaseProvider [props]\n  (let [config (.-config props)\n        conn (d/create-conn (merge (js->schema (.-schema config)) \n                                   base-schema))]\n    (when (.-initialData config) (transact! conn (.-initialData config)))\n    (r/create-element\n     (.-Provider homebase-context) #js {:value conn}\n     (.-children props))))\n\n(defn ^:export useEntity [lookup]\n  (let [conn (react/useContext homebase-context)\n        [result setResult] (react/useState (d/entity @conn (js->entity-lookup lookup)))]\n    (react/useEffect\n     (fn [] (let [key (rand)]\n              (d/listen! conn key #(setResult (d/entity @conn (js->entity-lookup lookup))))\n              (fn [] (d/unlisten! conn key))))\n     #js [lookup])\n    [result]))\n\n(defn ^:export useQuery [query & args]\n  (let [conn (react/useContext homebase-context)\n        [result setResult] (react/useState (apply q-entity-array (js->query query) conn (keywordize args)))]\n    (react/useEffect\n     (fn [] (let [key (rand)]\n              (d/listen! conn key #(setResult (apply q-entity-array (js->query query) conn (keywordize args))))\n              (fn [] (d/unlisten! conn key))))\n     #js [query args])\n    [result]))\n\n(defn ^:export useTransact []\n  (let [conn (react/useContext homebase-context)\n        transact (fn [txs] (transact! conn txs))]\n    [transact]))"]}