{"version":3,"sources":["homebase/js.cljs"],"mappings":"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","names":["homebase.js/keywordize-str","s","cljs.core._EQ_","cljs.core.subs","cljs.core.keyword","homebase.js/keywordize","coll","cljs.core.js__GT_clj","clojure.walk/postwalk","homebase.js/js->db-attr-overrides","homebase.js/bool-re","homebase.js/js->bool-key","string","temp__5735__auto__","vec__23887","cljs.core.nth","_","verb","key","cljs.core/re-find","homebase.js/js->key-not-memo","namespace","or__4126__auto__","cljs.core.get","camel-snake-kebab.core/->kebab-case","homebase.js/js->key","cljs.core/memoize","homebase.js/js-tx-fns","var_args","G__23891","homebase.js/js->tx","js/Error","tx","cljs.core/object?","homebase.js.js__GT_tx","vec__23892","f","e","a","v","data","cljs.core/reduce-kv","acc","k","cljs.core/coll?","cljs.core.assoc","homebase.js/js->entity-lookup","lookup","cljs.core/first","homebase.js/str->schema-key","homebase.js/js->schema","schema","cljs.core.reduce","p__23897","vec__23898","nms","nm","p","cljs.core.get_in","cljs.core/assoc-in","homebase.util/paths","args__4742__auto__","len__4736__auto__","i__4737__auto__","argseq__4743__auto__","cljs.core/IndexedSeq","homebase.js/q-entity-array","seq23901","G__23902","cljs.core/next","G__23903","self__4723__auto__","query","conn","args","cljs.core.apply","datascript.core/q","cljs.core.map","p__23906","vec__23907","id","datascript.core/entity","cljs.core/to-array","homebase.js/js->datalog","map__23910","cljs.core/PROTOCOL_SENTINEL","cljs.core/hash-map","find","where","cljs.core.symbol","cljs.core.mapv","p__23912","vec__23913","av","vec__23916","vec__23919","cljs.core/seq","pred","cljs.core.into","homebase.js/js->query","cljs.reader.read_string","homebase.js/js-get","entity","name","G__23922","ks","cljs.core.remove","cljs.core/keys","cljs.core/namespace","datascript.impl.entity/Entity","this","keys","cljs.core/Keyword","cljs.core/get","cljs.core/set?","G__23959","G__23960","G__23961","G__23962","homebase.js/nil->retract","temp__5733__auto__","p__23963","vec__23964","cljs.core.dissoc","homebase.js/transact!","txs","cljs.core.mapcat","cljs.core.comp","datascript.core.transact_BANG_","homebase.js/entity","G__23967","cljs.core/deref","G__23968","homebase.js/q","seq23969","G__23970","G__23971"],"sourcesContent":["(ns homebase.js\n  (:require\n   [homebase.util :as u]\n   [clojure.walk :as walk]\n   [camel-snake-kebab.core :as csk]\n   [datascript.core :as d]\n   [datascript.impl.entity :as de :refer [Entity]]))\n\n(defn keywordize-str [s]\n  (if (and (string? s) (= (subs s 0 1) \":\"))\n    (keyword (subs s 1))\n    s))\n\n(defn keywordize [coll]\n  (->> (js->clj coll)\n       (walk/postwalk keywordize-str)))\n\n(def js->db-attr-overrides\n  {\"id\" :db/id\n   \"identity\" :db/ident\n   \"ident\" :db/ident})\n\n(def bool-re #\"^(is|has|show|hide)(-|_)?(.*)\")\n\n(defn js->bool-key [string]\n  (when-let [[_ verb _ key] (re-find bool-re string)]\n    (if (= \"is\" verb) (str key \"?\") (str verb \"-\" key \"?\"))))\n\n(defn js->key-not-memo [namespace string]\n  (or\n   (get js->db-attr-overrides string)\n   (keyword (csk/->kebab-case namespace)\n            (csk/->kebab-case\n             (or (js->bool-key string)\n                 string)))))\n(def js->key (memoize js->key-not-memo))\n\n(comment\n  (js->key \"ok\" \"watThing\")\n  (js->key \"ok\" \"id\")\n  (js->key \"ok\" \"is_good\"))\n\n(def js-tx-fns\n  {\"add\" :db/add\n   \"retract\" :db/retract\n   \"retractEntity\" :db.fn/retractEntity})\n\n(defn js->tx\n  ([tx]\n   (if (object? tx)\n     (js->tx tx \"db\")\n     (let [[f e a v] tx]\n       [(get js-tx-fns f) e (keywordize a) v])))\n  ([data namespace]\n   (reduce-kv\n    (fn js->tx-reducer [acc k v]\n      (if (coll? v)\n        (js->tx v k)\n        (assoc acc (js->key namespace k) v)))\n    {} (js->clj data))))\n\n(defn js->entity-lookup [lookup]\n  (cond\n    (number? lookup) lookup\n    (object? lookup) (first (js->tx lookup))\n    :else nil))\n\n(comment\n  (js->tx #js {\"user\" {\"id\" -2\n                       \"name\" \"Arpegius\"}})\n  (map js->tx #js [{\"todoFilter\" {\"identity\" \"todoFilters\"\n                                  \"showCompleted\" true\n                                  \"project\" 0}}])\n  (first (js->tx #js {\"identity\" \"wat\"}))\n  (js->entity-lookup 1)\n  (js->entity-lookup #js {\"identity\" \"todoFilters\"}))\n\n(def str->schema-key\n  {\"unique\" :db/unique\n   \"identity\" :db.unique/identity\n   \"type\" :db/valueType\n   \"ref\" :db.type/ref})\n\n(defn js->schema [schema]\n  (let [schema (js->clj schema)]\n    (reduce (fn js->schema-reducer [acc [nms nm k :as p]]\n              (let [v (get str->schema-key (get-in schema p))\n                    k (get str->schema-key k)]\n                (assoc-in acc [(js->key nms nm) k] v)))\n            {} (u/paths schema))))\n\n(comment\n  (=\n   {:project/name #:db{:unique :db.unique/identity}\n    :todo/project #:db{:valueType :db.type/ref, :unique :db.unique/identity}\n    :todo/owner #:db{:valueType :db.type/ref}}\n   (js->schema #js {\"project\" {\"name\" {\"unique\" \"identity\"}}\n                    \"todo\" {\"project\" {\"type\" \"ref\"\n                                       \"unique\" \"identity\"}\n                            \"owner\" {\"type\" \"ref\"}}})))\n\n(defn q-entity-array [query conn & args]\n  (->> (apply d/q query conn args)\n       (map (fn id->entity [[id]] (d/entity conn id)))\n       to-array))\n\n(defn js->datalog [data]\n  (let [{find \"$find\" where \"$where\"} (js->clj data)]\n    {:find [(symbol (str \"?\" find))]\n     :where (mapv\n             (fn build-where-clause [[e av]]\n               (let [[[a v]] (seq av)\n                     pred [(symbol (str \"?\" e))\n                           (keyword e a)]]\n                 (if (= v \"$any\") pred\n                     (into pred [v]))))\n             where)}))\n\n(comment\n  (=\n   '[:find ?project\n     :where [[?project :project/name]]]\n   (js->datalog\n    #js {\"$find\" \"project\"\n         \"$where\" {\"project\" {\"name\" \"$any\"}}})))\n\n(defn js->query [query]\n  (cond\n    ; Assume datalog\n    ; NOTE: this only supports the most basic find clauses\n    ;       E.g. `:find ?e`\n    ;       Not  `:find ?e ...` or `:find ?e .` or `:find ?e ?a ?b`\n    ; TODO: should this support more complex :find queries?\n    (string? query) (cljs.reader/read-string query)\n    ; Assume JSON style query\n    (object? query) (js->datalog query)\n    :else nil))\n\n(defn js-get [entity name]\n  (case name\n    \"id\" (:db/id entity)\n    \"ident\" (:db/ident entity)\n    \"identity\" (:db/ident entity)\n    (let [ks (remove #{:db/id :db/ident} (keys entity))\n          ; This assumes that every entity only has keys of the same namespace once the :db keys are removed\n          nms (namespace (first ks))\n          k (js->key nms name)]\n      (get entity k))))\n\n(extend-type Entity\n  Object\n  (get [this & keys]\n    (reduce\n     (fn [acc key]\n       (let [key (keywordize key)\n             f (if (keyword? key) get js-get)]\n         (cond\n           (set? acc) (f (first acc) (keywordize key))\n           acc (f acc (keywordize key))\n           :else nil)))\n     this keys)))\n\n(defn nil->retract [tx]\n  (if-let [id (:db/id tx)]\n    (map (fn [[k v]]\n           [(if (nil? v) :db/retract :db/add) id k v])\n         (dissoc tx :db/id))\n    [tx]))\n\n(defn transact! [conn txs]\n  (let [txs (mapcat (comp nil->retract js->tx) txs)]\n    (d/transact! conn txs)))\n\n(defn entity [conn lookup]\n  (d/entity @conn (js->entity-lookup lookup)))\n\n(defn q [query conn & args]\n  (apply q-entity-array (js->query query) @conn (keywordize args)))"]}